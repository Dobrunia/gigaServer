<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Snippet Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
      rel="stylesheet"
    />
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    <style>
      :root {
        --bg: #0b0d12;
        --bg-elev: #111420;
        --text: #e6e9ef;
        --muted: #9aa3b2;
        --accent: #6ea8fe;
        --ok: #3cc36a;
        --warn: #f7b955;
        --crit: #ff6b6b;
        --border: #2a2f3a;
        --radius: 10px;
        --gap: 12px;
        --pad: 12px;
        --font-mono: ui-monospace, Consolas, monospace;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--text);
        font: 14px/1.4 system-ui;
      }

      .card {
        background: var(--bg-elev);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: var(--pad);
      }

      .snippet-card {
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .snippet-card:hover {
        /* transform: translateY(-2px); */
        border-color: var(--accent);
      }

      .code-preview {
        font-family: var(--font-mono);
        font-size: 12px;
        line-height: 1.4;
        max-height: 150px;
        overflow: auto; /* –µ–¥–∏–Ω—ã–π —Å–∫—Ä–æ–ª–ª –¥–ª—è –≤—Å–µ–≥–æ –±–ª–æ–∫–∞ */
        background: #1a1a1a;
        border-radius: 6px;
        margin-top: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        -ms-overflow-style: none; /* IE/Edge —Å–∫—Ä—ã—Ç—å –ø–æ–ª–æ—Å—É */
        scrollbar-width: none; /* Firefox —Å–∫—Ä—ã—Ç—å –ø–æ–ª–æ—Å—É */
      }
      .code-preview::-webkit-scrollbar {
        width: 0;
        height: 0;
      }

      .code-preview-numbers {
        background: #1a1a1a;
        color: #666;
        padding: 8px 6px 8px 8px;
        font-family: var(--font-mono);
        font-size: 11px;
        line-height: 1.4;
        user-select: none;
        border-right: 1px solid #333;
        min-width: 30px;
        text-align: right;
        flex-shrink: 0;
        white-space: pre;
        overflow: hidden; /* –±–ª–æ–∫–∏—Ä—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
        position: relative; /* –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π */
      }

      .code-preview-content {
        flex: 1;
        padding: 8px 8px 8px 6px;
        font-family: var(--font-mono);
        font-size: 12px;
        line-height: 1.4;
        color: var(--text);
        white-space: pre-wrap;
        word-wrap: break-word;
        background: transparent !important;
        overflow: hidden; /* –±–ª–æ–∫–∏—Ä—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
        position: relative; /* –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π */
      }

      .language-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        text-transform: uppercase;
        color: var(--text) !important; /* force readable text color */
      }

      .search-input {
        background: var(--bg-elev);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 8px 12px;
        color: var(--text);
        width: 100%;
      }

      .search-input:focus {
        outline: none;
        border-color: var(--accent);
      }

      .btn {
        background: var(--accent);
        color: white;
        border: none;
        border-radius: var(--radius);
        padding: 8px 16px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
      }

      .btn:hover {
        background: #5a9cfe;
        /* transform: translateY(-1px); */
      }

      .btn-secondary {
        background: var(--border);
        color: var(--text);
        border: none;
        border-radius: var(--radius);
        padding: 8px 16px;
      }

      .btn-secondary:hover {
        background: #3a3f4a;
      }

      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .modal-content {
        background: var(--bg-elev);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 24px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-label {
        display: block;
        margin-bottom: 4px;
        font-weight: 500;
        color: var(--text);
      }

      .form-input {
        width: 100%;
        padding: 8px 12px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text);
        font-family: var(--font-mono);
      }

      .form-input:focus {
        outline: none;
        border-color: var(--accent);
      }

      .form-textarea {
        min-height: 200px;
        resize: vertical;
        background: #1a1a1a !important;
        border: 1px solid #333 !important;
      }

      .code-editor-container {
        display: flex;
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 6px;
        overflow: hidden;
        min-height: 200px;
      }

      .code-editor-numbers {
        background: #1a1a1a;
        color: #666;
        padding: 8px 8px 8px 12px;
        font-family: var(--font-mono);
        font-size: 14px;
        line-height: 1.5;
        user-select: none;
        border-right: 1px solid #333;
        min-width: 40px;
        text-align: right;
        flex-shrink: 0;
        white-space: pre;
      }

      .code-editor-textarea {
        flex: 1;
        background: #1a1a1a !important;
        border: none !important;
        padding: 8px 12px 8px 8px;
        font-family: var(--font-mono);
        font-size: 14px;
        line-height: 1.5;
        color: var(--text);
        resize: none;
        outline: none;
        min-height: 184px;
      }

      .hidden {
        display: none;
      }

      .language-colors {
        --javascript: #f7df1e;
        --typescript: #3178c6;
        --python: #3776ab;
        --rust: #ce422b;
        --go: #00add8;
        --haskell: #5d4f85;
        --perl: #39457e;
        --html: #e34f26;
        --css: #1572b6;
        --json: #000000;
        --sql: #336791;
        --bash: #4eaa25;
        --default: #6ea8fe;
      }

      .lang-javascript {
        background: var(--javascript);
        color: #000;
      }
      .lang-typescript {
        background: var(--typescript);
        color: white;
      }
      .lang-python {
        background: var(--python);
        color: white;
      }
      .lang-rust {
        background: var(--rust);
        color: white;
      }
      .lang-go {
        background: var(--go);
        color: white;
      }
      .lang-haskell {
        background: var(--haskell);
        color: white;
      }
      .lang-perl {
        background: var(--perl);
        color: white;
      }
      .lang-html {
        background: var(--html);
        color: white;
      }
      .lang-css {
        background: var(--css);
        color: white;
      }
      .lang-json {
        background: var(--json);
        color: white;
      }
      .lang-sql {
        background: var(--sql);
        color: white;
      }
      .lang-bash {
        background: var(--bash);
        color: white;
      }
      .lang-default {
        background: var(--default);
        color: white;
      }

      /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–æ–¥–∞ */
      .code-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }

      .code-modal-content {
        background: var(--bg-elev);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        width: 95%;
        max-width: 1200px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .code-modal-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--bg);
      }

      .code-modal-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text);
      }

      .code-modal-close {
        background: var(--border);
        color: var(--text);
        border: none;
        border-radius: 6px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 16px;
      }

      .code-modal-close:hover {
        background: var(--crit);
        color: white;
      }

      .code-modal-body {
        flex: 1;
        overflow: auto;
        padding: 0;
      }

      .code-modal-code {
        font-family: var(--font-mono);
        font-size: 14px;
        line-height: 1.5;
        background: #0d1117;
        color: var(--text);
        padding: 20px;
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-x: auto;
        min-height: 200px;
        display: block;
      }

      .code-modal-code-container {
        display: flex;
        background: #1a1a1a;
        border-radius: 6px;
        overflow: hidden;
        border: 1px solid #333;
      }

      .code-modal-line-numbers {
        background: #1a1a1a;
        color: #666;
        padding: 20px 12px 20px 20px;
        font-family: var(--font-mono);
        font-size: 14px;
        line-height: 1.5;
        user-select: none;
        border-right: 1px solid #333;
        min-width: 50px;
        text-align: right;
        flex-shrink: 0;
        white-space: pre;
      }

      .code-modal-code-content {
        flex: 1;
        padding: 20px 20px 20px 12px;
        font-family: var(--font-mono);
        font-size: 14px;
        line-height: 1.5;
        color: var(--text);
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-x: auto;
        background: #1a1a1a;
      }

      .code-modal-actions {
        padding: 16px 20px;
        border-top: 1px solid var(--border);
        display: flex;
        gap: 12px;
        background: var(--bg);
      }

      .code-modal-btn {
        background: var(--accent);
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
      }

      .code-modal-btn:hover {
        background: #5a9cfe;
        transform: translateY(-1px);
      }

      .code-modal-btn-secondary {
        background: var(--border);
        color: var(--text);
      }

      .code-modal-btn-secondary:hover {
        background: #3a3f4a;
      }
    </style>
  </head>
  <body class="p-4">
    <header class="mb-6">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-bold">üìù Snippet Manager</h1>
        <button id="addSnippetBtn" class="btn">+ –ù–æ–≤—ã–π —Å–Ω–∏–ø–µ—Ç</button>
        <a href="/navigation" class="text-sm text-[#6ea8fe] underline">Back</a>
      </div>

      <div class="card bg-transparent border-none">
        <div class="form-group">
          <label class="form-label">üîç –ü–æ–∏—Å–∫ —Å–Ω–∏–ø–µ—Ç–æ–≤</label>
          <input
            type="text"
            id="searchInput"
            class="search-input"
            placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–Ω–∏–ø–µ—Ç–∞..."
          />
        </div>
      </div>
    </header>

    <div id="snippetsContainer" class="grid gap-4">
      <!-- –°–Ω–∏–ø–µ—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–æ–¥–∞ -->
    <div id="codeModal" class="code-modal hidden">
      <div class="code-modal-content">
        <div class="code-modal-header">
          <h3 id="codeModalTitle" class="code-modal-title">–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–¥–∞</h3>
          <button id="closeCodeModal" class="code-modal-close">‚úï</button>
        </div>
        <div class="code-modal-body">
          <div class="code-modal-code-container">
            <div id="codeModalLineNumbers" class="code-modal-line-numbers"></div>
            <pre id="codeModalCode" class="code-modal-code-content"></pre>
          </div>
        </div>
        <div class="code-modal-actions">
          <button id="copyCodeBtn" class="code-modal-btn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
          <button id="closeCodeModalBtn" class="btn-secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–Ω–∏–ø–µ—Ç–∞ -->
    <div id="snippetModal" class="modal hidden">
      <div class="modal-content">
        <div class="flex items-center justify-between mb-4">
          <h2 id="modalTitle" class="text-xl font-bold">–ù–æ–≤—ã–π —Å–Ω–∏–ø–µ—Ç</h2>
          <button id="closeModal" class="btn-secondary">‚úï</button>
        </div>

        <form id="snippetForm">
          <div class="form-group">
            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input
              type="text"
              id="snippetName"
              class="form-input"
              placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–Ω–∏–ø–µ—Ç–∞"
              required
            />
          </div>

          <div class="form-group">
            <label class="form-label">–Ø–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è</label>
            <select id="snippetLanguage" class="form-input">
              <option value="javascript">JavaScript</option>
              <option value="typescript">TypeScript</option>
              <option value="python">Python</option>
              <option value="rust">Rust</option>
              <option value="go">Go</option>
              <option value="haskell">Haskell</option>
              <option value="perl">Perl</option>
              <option value="html">HTML</option>
              <option value="css">CSS</option>
              <option value="json">JSON</option>
              <option value="sql">SQL</option>
              <option value="bash">Bash</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">–ö–æ–¥</label>
            <div class="code-editor-container">
              <div id="editorLineNumbers" class="code-editor-numbers">1</div>
              <textarea
                id="snippetCode"
                class="code-editor-textarea"
                placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Å–Ω–∏–ø–µ—Ç–∞..."
                required
              ></textarea>
            </div>
          </div>

          <div class="flex gap-3">
            <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button type="button" id="cancelBtn" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // –ï–¥–∏–Ω—ã–π –Ω–∞–±–æ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —è–∑—ã–∫–æ–≤ (–¥–æ–±–∞–≤–ª—è–π/—É–¥–∞–ª—è–π –∑–¥–µ—Å—å)
      const SUPPORTED_LANGUAGES = new Set([
        'javascript',
        'typescript',
        'python',
        'rust',
        'go',
        'haskell',
        'perl',
        'html',
        'css',
        'json',
        'sql',
        'bash',
      ]);

      const LANG_LABELS = {
        javascript: 'JavaScript',
        typescript: 'TypeScript',
        python: 'Python',
        rust: 'Rust',
        go: 'Go',
        haskell: 'Haskell',
        perl: 'Perl',
        html: 'HTML',
        css: 'CSS',
        json: 'JSON',
        sql: 'SQL',
        bash: 'Bash',
      };

      function labelForLang(lang) {
        return LANG_LABELS[lang] || lang.charAt(0).toUpperCase() + lang.slice(1);
      }

      class SnippetManager {
        constructor() {
          this.snippets = this.loadSnippets();
          this.currentSnippetId = null;
          this.activeLang = 'all';
          this.init();
        }

        init() {
          this.bindEvents();
          this.renderSnippets();
        }

        bindEvents() {
          // –ü–æ–∏—Å–∫
          document.getElementById('searchInput').addEventListener('input', (e) => {
            this.filterSnippets(e.target.value);
          });

          // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞/—Ñ–∏–ª—å—Ç—Ä –ø–æ —è–∑—ã–∫—É
          this.installLanguageFilter();

          // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
          document.getElementById('addSnippetBtn').addEventListener('click', () => {
            this.openModal();
          });

          document.getElementById('closeModal').addEventListener('click', () => {
            this.closeModal();
          });

          document.getElementById('cancelBtn').addEventListener('click', () => {
            this.closeModal();
          });

          // –§–æ—Ä–º–∞
          document.getElementById('snippetForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.saveSnippet();
          });

          // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
          document.getElementById('snippetModal').addEventListener('click', (e) => {
            if (e.target.id === 'snippetModal') {
              this.closeModal();
            }
          });

          // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–æ–¥–∞
          document.getElementById('closeCodeModal').addEventListener('click', () => {
            this.closeCodeModal();
          });

          document.getElementById('closeCodeModalBtn').addEventListener('click', () => {
            this.closeCodeModal();
          });

          document.getElementById('copyCodeBtn').addEventListener('click', () => {
            this.copyCodeFromModal();
          });

          // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–æ–¥–∞
          document.getElementById('codeModal').addEventListener('click', (e) => {
            if (e.target.id === 'codeModal') {
              this.closeCodeModal();
            }
          });

          // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–æ–≤ —Å—Ç—Ä–æ–∫ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
          const codeTextarea = document.getElementById('snippetCode');
          codeTextarea.addEventListener('input', () => {
            this.updateEditorLineNumbers();
          });
          codeTextarea.addEventListener('scroll', () => {
            this.syncEditorScroll();
          });
        }

        loadSnippets() {
          this.fetchFromServer();
          return [];
        }

        async fetchFromServer() {
          try {
            const res = await fetch('/rust/snippets/list');
            const data = await res.json();
            this.snippets = Array.isArray(data.snippets) ? data.snippets : [];
            this.renderSnippets();
          } catch (e) {
            console.warn('Failed to load snippets:', e);
            this.snippets = [];
            this.renderSnippets();
          }
        }

        saveSnippets() {}

        filterSnippets(query) {
          const q = (query || '').toLowerCase();
          const filtered = this.snippets
            .filter(
              (s) => this.activeLang === 'all' || s.language.toLowerCase() === this.activeLang
            )
            .filter(
              (snippet) =>
                snippet.name.toLowerCase().includes(q) || snippet.code.toLowerCase().includes(q)
            );
          this.renderSnippets(filtered);
        }

        installLanguageFilter() {
          const container = document.querySelector('header .card');
          if (!container) return;
          const row = document.createElement('div');
          row.className = 'form-group';
          // –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –æ–ø—Ü–∏–π –∏–∑ –Ω–∞–±–æ—Ä–∞ SUPPORTED_LANGUAGES
          const options = ['<option value="all">–í—Å–µ —è–∑—ã–∫–∏</option>']
            .concat(
              Array.from(SUPPORTED_LANGUAGES).map(
                (l) => `<option value="${l}">${labelForLang(l)}</option>`
              )
            )
            .join('');
          row.innerHTML = `
            <label class="form-label">üß† –§–∏–ª—å—Ç—Ä –ø–æ —è–∑—ã–∫—É</label>
            <select id="langFilter" class="search-input" style="max-width: 260px;">${options}</select>
          `;
          container.appendChild(row);
          row.querySelector('#langFilter').addEventListener('change', (e) => {
            this.activeLang = e.target.value;
            this.filterSnippets(document.getElementById('searchInput').value);
          });
        }

        renderSnippets(snippets = this.snippets) {
          const container = document.getElementById('snippetsContainer');

          if (snippets.length === 0) {
            container.innerHTML = `
                        <div class="card text-center text-muted">
                            <p>–°–Ω–∏–ø–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                        </div>
                    `;
            return;
          }

          container.innerHTML = snippets
            .map(
              (snippet) => `
                    <div class="card snippet-card" data-id="${snippet.id}">
                        <div class="flex items-start justify-between mb-2">
                            <h3 class="text-lg font-semibold">${snippet.name}</h3>
                            <span class="language-badge lang-${snippet.language}">${
                snippet.language
              }</span>
                        </div>
                        <div class="code-preview" onclick="snippetManager.viewCode(${
                          snippet.id
                        })" onscroll="snippetManager.syncPreviewScroll(event)" title="–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–∞ –ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω">
                          <div class="code-preview-numbers">${this.generateLineNumbers(
                            snippet.code,
                            10
                          )}</div>
                          <pre class="code-preview-content"><code class="language-${
                            snippet.language
                          }">${this.escapeHtml(this.truncateCode(snippet.code, 10))}</code></pre>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button class="btn-secondary text-xs" onclick="snippetManager.editSnippet(${
                              snippet.id
                            })">
                                ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                            <button class="btn-secondary text-xs" onclick="snippetManager.copySnippet(${
                              snippet.id
                            })">
                                üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                            <button class="btn-secondary text-xs" onclick="snippetManager.viewCode(${
                              snippet.id
                            })">
                                üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä
                            </button>
                            <button class="btn-secondary text-xs" onclick="snippetManager.deleteSnippet(${
                              snippet.id
                            })">
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    </div>
                `
            )
            .join('');

          // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
          if (typeof Prism !== 'undefined') {
            Prism.highlightAll();
          }
        }

        openModal(snippetId = null) {
          this.currentSnippetId = snippetId;
          const modal = document.getElementById('snippetModal');
          const title = document.getElementById('modalTitle');
          const form = document.getElementById('snippetForm');

          if (snippetId) {
            const snippet = this.snippets.find((s) => s.id === snippetId);
            title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–Ω–∏–ø–µ—Ç';
            document.getElementById('snippetName').value = snippet.name;
            document.getElementById('snippetLanguage').value = snippet.language;
            document.getElementById('snippetCode').value = snippet.code;
          } else {
            title.textContent = '–ù–æ–≤—ã–π —Å–Ω–∏–ø–µ—Ç';
            form.reset();
          }

          modal.classList.remove('hidden');
          document.getElementById('snippetName').focus();

          // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–æ–∫ –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
          setTimeout(() => {
            this.updateEditorLineNumbers();
          }, 100);
        }

        closeModal() {
          document.getElementById('snippetModal').classList.add('hidden');
          this.currentSnippetId = null;
        }

        saveSnippet() {
          const name = document.getElementById('snippetName').value;
          const language = document.getElementById('snippetLanguage').value;
          const code = document.getElementById('snippetCode').value;

          if (!name || !code) return;

          fetch('/rust/snippets/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: this.currentSnippetId, name, language, code }),
          })
            .then((r) => r.json())
            .then((res) => {
              if (res.ok) {
                this.fetchFromServer();
                this.closeModal();
              } else {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (res.error || 'unknown'));
              }
            })
            .catch((e) => alert('–û—à–∏–±–∫–∞: ' + e));
        }

        editSnippet(id) {
          this.openModal(id);
        }

        copySnippet(id) {
          const snippet = this.snippets.find((s) => s.id === id);
          navigator.clipboard.writeText(snippet.code).then(() => {
            // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
            btn.style.background = 'var(--ok)';
            setTimeout(() => {
              btn.textContent = originalText;
              btn.style.background = '';
            }, 2000);
          });
        }

        deleteSnippet(id) {
          if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Å–Ω–∏–ø–µ—Ç?')) return;
          fetch('/rust/snippets/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id }),
          })
            .then((r) => r.json())
            .then((res) => {
              if (res.ok) this.fetchFromServer();
              else alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (res.error || 'unknown'));
            })
            .catch((e) => alert('–û—à–∏–±–∫–∞: ' + e));
        }

        viewCode(id) {
          const snippet = this.snippets.find((s) => s.id === id);
          if (!snippet) {
            console.error('Snippet not found:', id);
            return;
          }

          console.log('Opening code modal for snippet:', snippet);

          const modal = document.getElementById('codeModal');
          const title = document.getElementById('codeModalTitle');
          const codeElement = document.getElementById('codeModalCode');

          if (!modal || !title || !codeElement) {
            console.error('Modal elements not found');
            return;
          }

          title.textContent = `${snippet.name} (${snippet.language})`;

          // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–æ–∫
          const lines = snippet.code.split('\n');
          const lineNumbers = lines.map((_, index) => index + 1).join('\n');

          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–æ–∫ –∏ –∫–æ–¥
          const lineNumbersElement = document.getElementById('codeModalLineNumbers');
          lineNumbersElement.textContent = lineNumbers;

          codeElement.textContent = snippet.code;
          codeElement.className = `code-modal-code-content language-${snippet.language}`;

          console.log('Code element content:', codeElement.textContent);
          console.log('Line numbers:', lineNumbers);

          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden';

          // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
          setTimeout(() => {
            if (typeof Prism !== 'undefined') {
              Prism.highlightElement(codeElement);
            }
          }, 100);
        }

        closeCodeModal() {
          const modal = document.getElementById('codeModal');
          modal.classList.add('hidden');
          document.body.style.overflow = '';
        }

        copyCodeFromModal() {
          const codeElement = document.getElementById('codeModalCode');
          const code = codeElement.textContent;

          navigator.clipboard.writeText(code).then(() => {
            const btn = document.getElementById('copyCodeBtn');
            const originalText = btn.textContent;
            btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
            btn.style.background = 'var(--ok)';
            setTimeout(() => {
              btn.textContent = originalText;
              btn.style.background = '';
            }, 2000);
          });
        }

        generateLineNumbers(code, maxLines = 10) {
          const lines = code.split('\n');
          const visibleLines = lines.slice(0, maxLines);
          return visibleLines.map((_, index) => index + 1).join('\n');
        }

        truncateCode(code, maxLines = 10) {
          const lines = code.split('\n');
          if (lines.length <= maxLines) {
            return code;
          }
          return lines.slice(0, maxLines).join('\n') + '\n...';
        }

        updateEditorLineNumbers() {
          const textarea = document.getElementById('snippetCode');
          const lineNumbers = document.getElementById('editorLineNumbers');

          if (!textarea || !lineNumbers) return;

          const lines = textarea.value.split('\n');
          const numbers = lines.map((_, index) => index + 1).join('\n');
          lineNumbers.textContent = numbers;
        }

        syncEditorScroll() {
          const textarea = document.getElementById('snippetCode');
          const lineNumbers = document.getElementById('editorLineNumbers');

          if (!textarea || !lineNumbers) return;

          lineNumbers.scrollTop = textarea.scrollTop;
        }

        // –ü—Ä–æ—Å—Ç–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–∫—Ä–æ–ª–ª–∞ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        syncPreviewScroll(e) {
          e.stopPropagation();

          const container = e.currentTarget;
          const numbers = container.querySelector('.code-preview-numbers');
          const content = container.querySelector('.code-preview-content');

          if (!numbers || !content) return;

          // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª —á–µ—Ä–µ–∑ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
          const scrollTop = container.scrollTop;
          const scrollLeft = container.scrollLeft;

          numbers.style.transform = `translateY(${-scrollTop}px)`;
          content.style.transform = `translate(${-scrollLeft}px, ${-scrollTop}px)`;
        }

        escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      const snippetManager = new SnippetManager();
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Snippet Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
      rel="stylesheet"
    />
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    <style>
      :root {
        --bg: #0b0d12;
        --bg-elev: #111420;
        --text: #e6e9ef;
        --muted: #9aa3b2;
        --accent: #6ea8fe;
        --ok: #3cc36a;
        --warn: #f7b955;
        --crit: #ff6b6b;
        --border: #2a2f3a;
        --radius: 10px;
        --gap: 12px;
        --pad: 12px;
        --font-mono: ui-monospace, Consolas, monospace;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--text);
        font: 14px/1.4 system-ui;
      }

      .card {
        background: var(--bg-elev);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: var(--pad);
      }

      .snippet-card {
        transition: all 0.2s ease;
        cursor: pointer;
        width: 350px;
        flex-shrink: 0;
      }

      .snippet-card:hover {
        /* transform: translateY(-2px); */
        border-color: var(--accent);
      }

      .code-preview {
        font-family: var(--font-mono);
        font-size: 12px;
        line-height: 1.4;
        max-height: 150px;
        overflow: auto; /* единый скролл для всего блока */
        background: #1a1a1a;
        border-radius: 6px;
        margin-top: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        -ms-overflow-style: none; /* IE/Edge скрыть полосу */
        scrollbar-width: none; /* Firefox скрыть полосу */
      }
      .code-preview::-webkit-scrollbar {
        width: 0;
        height: 0;
      }

      .code-preview-wrapper {
        display: flex;
        background: #1a1a1a;
        min-height: 100%;
        min-width: 100%;
        width: max-content;
      }

      .code-preview-numbers {
        background: #1a1a1a;
        color: #666;
        padding: 8px 6px 8px 8px;
        font-family: var(--font-mono);
        font-size: 12px;
        line-height: 1.4;
        user-select: none;
        border-right: 1px solid #333;
        min-width: 30px;
        text-align: right;
        flex-shrink: 0;
        white-space: pre;
      }

      .code-preview-content {
        flex: 1;
        padding: 8px 8px 8px 6px;
        font-family: var(--font-mono);
        font-size: 12px;
        line-height: 1.4;
        color: var(--text);
        white-space: pre-wrap;
        word-wrap: break-word;
        background: transparent !important;
        margin: 0;
      }

      .code-preview-content code {
        margin: 0;
        padding: 0;
        background: transparent !important;
        font-family: inherit;
        font-size: inherit;
        line-height: inherit;
        display: block;
      }

      .code-line-number {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        min-height: 1.4em;
        font-family: var(--font-mono);
        font-size: 12px;
        line-height: 1.4;
        color: #666;
        user-select: none;
      }

      .code-line {
        display: flex;
        align-items: center;
        min-height: 1.4em;
        font-family: var(--font-mono);
        font-size: 12px;
        line-height: 1.4;
        color: var(--text);
      }

      /* Стили для модального окна */
      .code-modal-line-numbers .code-line-number {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        min-height: 1.5em;
        font-family: var(--font-mono);
        font-size: 14px;
        line-height: 1.5;
        color: #666;
        user-select: none;
      }

      .code-modal-code-content .code-line {
        display: flex;
        align-items: center;
        min-height: 1.5em;
        font-family: var(--font-mono);
        font-size: 14px;
        line-height: 1.5;
        color: var(--text);
      }

      .language-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        text-transform: uppercase;
        color: var(--text) !important; /* force readable text color */
      }

      /* Стили для чекбоксов фильтра */
      .filter-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid var(--border);
        transition: all 0.2s ease;
        user-select: none;
        min-height: 32px; /* фиксированная высота */
      }

      .filter-checkbox:hover {
        background: rgba(110, 168, 254, 0.1);
      }

      .filter-checkbox input[type='checkbox'] {
        appearance: none;
        width: 16px;
        height: 16px;
        border: 2px solid var(--border);
        border-radius: 4px;
        background: var(--bg);
        cursor: pointer;
        position: relative;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      .filter-checkbox input[type='checkbox']:checked {
        background: var(--accent);
        border-color: var(--accent);
      }

      .filter-checkbox input[type='checkbox']:checked::after {
        content: '✓';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 10px;
        font-weight: bold;
      }

      .filter-checkbox input[type='checkbox']:hover {
        border-color: var(--accent);
        transform: scale(1.05);
      }

      .filter-checkbox-label {
        font-size: 12px;
        font-weight: 500;
        white-space: nowrap;
        min-width: fit-content;
      }

      .filter-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
        min-height: 40px; /* фиксированная минимальная высота */
        align-items: flex-start;
      }

      .search-input {
        background: var(--bg-elev);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 8px 12px;
        color: var(--text);
        width: 100%;
      }

      .search-input:focus {
        outline: none;
        border-color: var(--accent);
      }

      .btn {
        background: var(--accent);
        color: white;
        border: none;
        border-radius: var(--radius);
        padding: 8px 16px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
      }

      .btn:hover {
        background: #5a9cfe;
        /* transform: translateY(-1px); */
      }

      .btn-secondary {
        background: var(--border);
        color: var(--text);
        border: none;
        border-radius: var(--radius);
        padding: 8px 16px;
      }

      .btn-secondary:hover {
        background: #3a3f4a;
      }

      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .modal-content {
        background: var(--bg-elev);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 24px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-label {
        display: block;
        margin-bottom: 4px;
        font-weight: 500;
        color: var(--text);
      }

      .form-input {
        width: 100%;
        padding: 8px 12px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text);
        font-family: var(--font-mono);
      }

      .form-input:focus {
        outline: none;
        border-color: var(--accent);
      }

      .form-textarea {
        min-height: 200px;
        resize: vertical;
        background: #1a1a1a !important;
        border: 1px solid #333 !important;
      }

      .code-editor-container {
        display: flex;
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 6px;
        overflow: hidden;
        min-height: 200px;
      }

      .code-editor-numbers {
        background: #1a1a1a;
        color: #666;
        padding: 8px 8px 8px 12px;
        font-family: var(--font-mono);
        font-size: 14px;
        line-height: 1.5;
        user-select: none;
        border-right: 1px solid #333;
        min-width: 40px;
        text-align: right;
        flex-shrink: 0;
        white-space: pre;
      }

      .code-editor-textarea {
        flex: 1;
        background: #1a1a1a !important;
        border: none !important;
        padding: 8px 12px 8px 8px;
        font-family: var(--font-mono);
        font-size: 14px;
        line-height: 1.5;
        color: var(--text);
        resize: none;
        outline: none;
        min-height: 184px;
      }

      .hidden {
        display: none;
      }

      .language-colors {
        --javascript: #f7df1e;
        --typescript: #3178c6;
        --python: #3776ab;
        --rust: #ce422b;
        --go: #00add8;
        --haskell: #5d4f85;
        --perl: #39457e;
        --ruby: #cc342d;
        --c: #00599c;
        --cpp: #00599c;
        --csharp: #239120;
        --java: #f89820;
        --php: #777bb4;
        --swift: #fa7343;
        --kotlin: #7f52ff;
        --scala: #dc322f;
        --clojure: #5881d8;
        --elixir: #4e2a8e;
        --erlang: #a90533;
        --lua: #000080;
        --r: #276dc3;
        --matlab: #e16737;
        --octave: #0790c0;
        --fortran: #734f96;
        --assembly: #6e4c13;
        --html: #e34f26;
        --css: #1572b6;
        --scss: #cf649a;
        --sass: #cf649a;
        --less: #1d365d;
        --json: #000000;
        --yaml: #cb171e;
        --xml: #ff6600;
        --sql: #336791;
        --bash: #4eaa25;
        --powershell: #012456;
        --dockerfile: #2496ed;
        --makefile: #427819;
        --cmake: #064f8c;
        --markdown: #083fa1;
        --latex: #008080;
        --tex: #008080;
        --default: #6ea8fe;
      }

      .lang-javascript {
        background: var(--javascript);
        color: #000;
      }
      .lang-typescript {
        background: var(--typescript);
        color: white;
      }
      .lang-python {
        background: var(--python);
        color: white;
      }
      .lang-rust {
        background: var(--rust);
        color: white;
      }
      .lang-go {
        background: var(--go);
        color: white;
      }
      .lang-haskell {
        background: var(--haskell);
        color: white;
      }
      .lang-perl {
        background: var(--perl);
        color: white;
      }
      .lang-html {
        background: var(--html);
        color: white;
      }
      .lang-css {
        background: var(--css);
        color: white;
      }
      .lang-json {
        background: var(--json);
        color: white;
      }
      .lang-sql {
        background: var(--sql);
        color: white;
      }
      .lang-bash {
        background: var(--bash);
        color: white;
      }
      .lang-ruby {
        background: var(--ruby);
        color: white;
      }
      .lang-c {
        background: var(--c);
        color: white;
      }
      .lang-cpp {
        background: var(--cpp);
        color: white;
      }
      .lang-csharp {
        background: var(--csharp);
        color: white;
      }
      .lang-java {
        background: var(--java);
        color: white;
      }
      .lang-php {
        background: var(--php);
        color: white;
      }
      .lang-swift {
        background: var(--swift);
        color: white;
      }
      .lang-kotlin {
        background: var(--kotlin);
        color: white;
      }
      .lang-scala {
        background: var(--scala);
        color: white;
      }
      .lang-clojure {
        background: var(--clojure);
        color: white;
      }
      .lang-elixir {
        background: var(--elixir);
        color: white;
      }
      .lang-erlang {
        background: var(--erlang);
        color: white;
      }
      .lang-lua {
        background: var(--lua);
        color: white;
      }
      .lang-r {
        background: var(--r);
        color: white;
      }
      .lang-matlab {
        background: var(--matlab);
        color: white;
      }
      .lang-octave {
        background: var(--octave);
        color: white;
      }
      .lang-fortran {
        background: var(--fortran);
        color: white;
      }
      .lang-assembly {
        background: var(--assembly);
        color: white;
      }
      .lang-scss {
        background: var(--scss);
        color: white;
      }
      .lang-sass {
        background: var(--sass);
        color: white;
      }
      .lang-less {
        background: var(--less);
        color: white;
      }
      .lang-yaml {
        background: var(--yaml);
        color: white;
      }
      .lang-xml {
        background: var(--xml);
        color: white;
      }
      .lang-powershell {
        background: var(--powershell);
        color: white;
      }
      .lang-dockerfile {
        background: var(--dockerfile);
        color: white;
      }
      .lang-makefile {
        background: var(--makefile);
        color: white;
      }
      .lang-cmake {
        background: var(--cmake);
        color: white;
      }
      .lang-markdown {
        background: var(--markdown);
        color: white;
      }
      .lang-latex {
        background: var(--latex);
        color: white;
      }
      .lang-tex {
        background: var(--tex);
        color: white;
      }
      .lang-default {
        background: var(--default);
        color: white;
      }

      /* Модальное окно для просмотра кода */
      .code-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }

      .code-modal-content {
        background: var(--bg-elev);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        width: 95%;
        max-width: 1200px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .code-modal-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--bg);
      }

      .code-modal-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text);
      }

      .code-modal-close {
        background: var(--border);
        color: var(--text);
        border: none;
        border-radius: 6px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 16px;
      }

      .code-modal-close:hover {
        background: var(--crit);
        color: white;
      }

      .code-modal-body {
        flex: 1;
        overflow: auto;
        padding: 0;
      }

      .code-modal-code {
        font-family: var(--font-mono);
        font-size: 14px;
        line-height: 1.5;
        background: #0d1117;
        color: var(--text);
        padding: 20px;
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-x: auto;
        min-height: 200px;
        display: block;
      }

      .code-modal-code-container {
        background: #1a1a1a;
        border-radius: 6px;
        overflow: auto;
        border: 1px solid #333;
        max-height: 60vh;
        position: relative;
      }

      .code-modal-code-wrapper {
        display: flex;
        background: #1a1a1a;
        min-height: 100%;
        min-width: 100%;
        width: max-content;
      }

      .code-modal-line-numbers {
        background: #1a1a1a;
        color: #666;
        padding: 20px 12px 20px 20px;
        font-family: var(--font-mono);
        font-size: 14px;
        line-height: 1.5;
        user-select: none;
        border-right: 1px solid #333;
        min-width: 50px;
        text-align: right;
        flex-shrink: 0;
        white-space: pre;
      }

      .code-modal-code-content {
        flex: 1;
        padding: 20px 20px 20px 12px;
        font-family: var(--font-mono);
        font-size: 14px;
        line-height: 1.5;
        color: var(--text);
        white-space: pre-wrap;
        word-wrap: break-word;
        background: #1a1a1a;
        margin: 0;
        display: block;
      }

      .code-modal-actions {
        padding: 16px 20px;
        border-top: 1px solid var(--border);
        display: flex;
        gap: 12px;
        background: var(--bg);
      }

      .code-modal-btn {
        background: var(--accent);
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
      }

      .code-modal-btn:hover {
        background: #5a9cfe;
        transform: translateY(-1px);
      }

      .code-modal-btn-secondary {
        background: var(--border);
        color: var(--text);
      }

      .code-modal-btn-secondary:hover {
        background: #3a3f4a;
      }
    </style>
  </head>
  <body class="p-4">
    <header class="mb-6">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-bold">📝 Snippet Manager</h1>
        <button id="addSnippetBtn" class="btn">+ Новый снипет</button>
        <a href="/navigation" class="text-sm text-[#6ea8fe] underline">Back</a>
      </div>

      <div class="card bg-transparent border-none">
        <div class="form-group">
          <label class="form-label">🔍 Поиск снипетов</label>
          <input
            type="text"
            id="searchInput"
            class="search-input"
            placeholder="Введите название снипета..."
          />
        </div>
      </div>
    </header>

    <div id="snippetsContainer" class="flex flex-wrap gap-4">
      <!-- Снипеты будут загружены здесь -->
    </div>

    <!-- Модальное окно для просмотра кода -->
    <div id="codeModal" class="code-modal hidden">
      <div class="code-modal-content">
        <div class="code-modal-header">
          <h3 id="codeModalTitle" class="code-modal-title">Просмотр кода</h3>
          <button id="closeCodeModal" class="code-modal-close">✕</button>
        </div>
        <div class="code-modal-body">
          <div class="code-modal-code-container">
            <div class="code-modal-code-wrapper">
              <div id="codeModalLineNumbers" class="code-modal-line-numbers"></div>
              <div id="codeModalCode" class="code-modal-code-content"></div>
            </div>
          </div>
        </div>
        <div class="code-modal-actions">
          <button id="copyCodeBtn" class="btn-secondary text-xs">📋 Копировать код</button>
        </div>
      </div>
    </div>

    <!-- Модальное окно для создания/редактирования снипета -->
    <div id="snippetModal" class="modal hidden">
      <div class="modal-content">
        <div class="flex items-center justify-between mb-4">
          <h2 id="modalTitle" class="text-xl font-bold">Новый снипет</h2>
          <button id="closeModal" class="btn-secondary">✕</button>
        </div>

        <form id="snippetForm">
          <div class="form-group">
            <label class="form-label">Название</label>
            <input
              type="text"
              id="snippetName"
              class="form-input"
              placeholder="Введите название снипета"
              required
            />
          </div>

          <div class="form-group">
            <label class="form-label">Язык программирования</label>
            <select id="snippetLanguage" class="form-input">
              <option value="javascript">🟨 JavaScript</option>
              <option value="typescript">🔷 TypeScript</option>
              <option value="python">🐍 Python</option>
              <option value="rust">🦀 Rust</option>
              <option value="go">🐹 Go</option>
              <option value="haskell">🔷 Haskell</option>
              <option value="perl">🐪 Perl</option>
              <option value="ruby">💎 Ruby</option>
              <option value="c">🔵 C</option>
              <option value="cpp">🔵 C++</option>
              <option value="csharp">🟣 C#</option>
              <option value="java">☕ Java</option>
              <option value="php">🐘 PHP</option>
              <option value="swift">🦉 Swift</option>
              <option value="kotlin">🟠 Kotlin</option>
              <option value="scala">🔴 Scala</option>
              <option value="clojure">🟢 Clojure</option>
              <option value="elixir">💜 Elixir</option>
              <option value="erlang">🟡 Erlang</option>
              <option value="lua">🌙 Lua</option>
              <option value="r">📊 R</option>
              <option value="matlab">🧮 MATLAB</option>
              <option value="octave">🎵 Octave</option>
              <option value="fortran">🔢 Fortran</option>
              <option value="assembly">⚙️ Assembly</option>
              <option value="html">🌐 HTML</option>
              <option value="css">🎨 CSS</option>
              <option value="scss">🎨 SCSS</option>
              <option value="sass">🎨 Sass</option>
              <option value="less">🎨 Less</option>
              <option value="json">📄 JSON</option>
              <option value="yaml">📝 YAML</option>
              <option value="xml">📋 XML</option>
              <option value="sql">🗄️ SQL</option>
              <option value="bash">🐚 Bash</option>
              <option value="powershell">💻 PowerShell</option>
              <option value="dockerfile">🐳 Dockerfile</option>
              <option value="makefile">🔧 Makefile</option>
              <option value="cmake">🔧 CMake</option>
              <option value="markdown">📝 Markdown</option>
              <option value="latex">📚 LaTeX</option>
              <option value="tex">📚 TeX</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Код</label>
            <div class="code-editor-container">
              <div id="editorLineNumbers" class="code-editor-numbers">1</div>
              <textarea
                id="snippetCode"
                class="code-editor-textarea"
                placeholder="Введите код снипета..."
                required
              ></textarea>
            </div>
          </div>

          <div class="flex gap-3">
            <button type="submit" class="btn">Сохранить</button>
            <button type="button" id="cancelBtn" class="btn-secondary">Отмена</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Единый набор поддерживаемых языков (добавляй/удаляй здесь)
      const SUPPORTED_LANGUAGES = new Set([
        'javascript',
        'typescript',
        'python',
        'rust',
        'go',
        'haskell',
        'perl',
        'ruby',
        'c',
        'cpp',
        'csharp',
        'java',
        'php',
        'swift',
        'kotlin',
        'scala',
        'clojure',
        'elixir',
        'erlang',
        'lua',
        'r',
        'matlab',
        'octave',
        'fortran',
        'assembly',
        'html',
        'css',
        'scss',
        'sass',
        'less',
        'json',
        'yaml',
        'xml',
        'sql',
        'bash',
        'powershell',
        'dockerfile',
        'makefile',
        'cmake',
        'markdown',
        'latex',
        'tex',
      ]);

      const LANG_LABELS = {
        javascript: 'JavaScript',
        typescript: 'TypeScript',
        python: 'Python',
        rust: 'Rust',
        go: 'Go',
        haskell: 'Haskell',
        perl: 'Perl',
        ruby: 'Ruby',
        c: 'C',
        cpp: 'C++',
        csharp: 'C#',
        java: 'Java',
        php: 'PHP',
        swift: 'Swift',
        kotlin: 'Kotlin',
        scala: 'Scala',
        clojure: 'Clojure',
        elixir: 'Elixir',
        erlang: 'Erlang',
        lua: 'Lua',
        r: 'R',
        matlab: 'MATLAB',
        octave: 'Octave',
        fortran: 'Fortran',
        assembly: 'Assembly',
        html: 'HTML',
        css: 'CSS',
        scss: 'SCSS',
        sass: 'Sass',
        less: 'Less',
        json: 'JSON',
        yaml: 'YAML',
        xml: 'XML',
        sql: 'SQL',
        bash: 'Bash',
        powershell: 'PowerShell',
        dockerfile: 'Dockerfile',
        makefile: 'Makefile',
        cmake: 'CMake',
        markdown: 'Markdown',
        latex: 'LaTeX',
        tex: 'TeX',
      };

      const LANG_EMOJIS = {
        javascript: '🟨',
        typescript: '🔷',
        python: '🐍',
        rust: '🦀',
        go: '🐹',
        haskell: '🔷',
        perl: '🐪',
        ruby: '💎',
        c: '🔵',
        cpp: '🔵',
        csharp: '🟣',
        java: '☕',
        php: '🐘',
        swift: '🦉',
        kotlin: '🟠',
        scala: '🔴',
        clojure: '🟢',
        elixir: '💜',
        erlang: '🟡',
        lua: '🌙',
        r: '📊',
        matlab: '🧮',
        octave: '🎵',
        fortran: '🔢',
        assembly: '⚙️',
        html: '🌐',
        css: '🎨',
        scss: '🎨',
        sass: '🎨',
        less: '🎨',
        json: '📄',
        yaml: '📝',
        xml: '📋',
        sql: '🗄️',
        bash: '🐚',
        powershell: '💻',
        dockerfile: '🐳',
        makefile: '🔧',
        cmake: '🔧',
        markdown: '📝',
        latex: '📚',
        tex: '📚',
      };

      function labelForLang(lang) {
        return LANG_LABELS[lang] || lang.charAt(0).toUpperCase() + lang.slice(1);
      }

      function emojiForLang(lang) {
        return LANG_EMOJIS[lang] || '📄';
      }

      class SnippetManager {
        constructor() {
          this.snippets = this.loadSnippets();
          this.currentSnippetId = null;
          this.activeLang = 'all';
          this.init();
        }

        init() {
          this.bindEvents();
          this.renderSnippets();
        }

        bindEvents() {
          // Поиск
          document.getElementById('searchInput').addEventListener('input', (e) => {
            this.filterSnippets(e.target.value);
          });

          // Сортировка/фильтр по языку
          this.installLanguageFilter();

          // Модальное окно создания/редактирования
          document.getElementById('addSnippetBtn').addEventListener('click', () => {
            this.openModal();
          });

          document.getElementById('closeModal').addEventListener('click', () => {
            this.closeModal();
          });

          document.getElementById('cancelBtn').addEventListener('click', () => {
            this.closeModal();
          });

          // Форма
          document.getElementById('snippetForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.saveSnippet();
          });

          // Закрытие по клику вне модального окна
          document.getElementById('snippetModal').addEventListener('click', (e) => {
            if (e.target.id === 'snippetModal') {
              this.closeModal();
            }
          });

          // Модальное окно просмотра кода
          document.getElementById('closeCodeModal').addEventListener('click', () => {
            this.closeCodeModal();
          });

          document.getElementById('copyCodeBtn').addEventListener('click', () => {
            this.copyCodeFromModal();
          });

          // Закрытие по клику вне модального окна просмотра кода
          document.getElementById('codeModal').addEventListener('click', (e) => {
            if (e.target.id === 'codeModal') {
              this.closeCodeModal();
            }
          });

          // Обновление номеров строк в редакторе
          const codeTextarea = document.getElementById('snippetCode');
          codeTextarea.addEventListener('input', () => {
            this.updateEditorLineNumbers();
          });
          codeTextarea.addEventListener('scroll', () => {
            this.syncEditorScroll();
          });
        }

        loadSnippets() {
          this.fetchFromServer();
          return [];
        }

        async fetchFromServer() {
          try {
            const res = await fetch('/rust/snippets/list');
            const data = await res.json();
            this.snippets = Array.isArray(data.snippets) ? data.snippets : [];
            this.renderSnippets();
          } catch (e) {
            console.warn('Failed to load snippets:', e);
            this.snippets = [];
            this.renderSnippets();
          }
        }

        saveSnippets() {}

        filterSnippets(query) {
          const q = (query || '').toLowerCase();

          // Получаем выбранные языки
          const selectedLanguages = this.getSelectedLanguages();

          const filtered = this.snippets
            .filter((s) => {
              // Если выбраны все языки или нет выбранных языков
              if (selectedLanguages.length === 0 || selectedLanguages.includes('all')) {
                return true;
              }
              // Фильтруем по выбранным языкам
              return selectedLanguages.includes(s.language.toLowerCase());
            })
            .filter(
              (snippet) =>
                snippet.name.toLowerCase().includes(q) || snippet.code.toLowerCase().includes(q)
            );
          this.renderSnippets(filtered);
        }

        getSelectedLanguages() {
          const allCheckbox = document.getElementById('lang-all');
          const langCheckboxes = document.querySelectorAll('.lang-checkbox[data-lang]');

          // Если выбрано "Все языки"
          if (allCheckbox && allCheckbox.checked) {
            return ['all'];
          }

          // Собираем выбранные языки
          const selected = [];
          langCheckboxes.forEach((checkbox) => {
            if (checkbox.checked) {
              selected.push(checkbox.dataset.lang);
            }
          });

          return selected;
        }

        installLanguageFilter() {
          const container = document.querySelector('header .card');
          if (!container) return;
          const row = document.createElement('div');
          row.className = 'form-group';

          // Создаем контейнер для чекбоксов с фиксированными размерами
          const checkboxesContainer = document.createElement('div');
          checkboxesContainer.className = 'filter-container';

          // Создаем чекбокс "Все языки"
          const allCheckbox = document.createElement('label');
          allCheckbox.className = 'filter-checkbox';
          allCheckbox.innerHTML = `
            <input type="checkbox" id="lang-all" class="lang-checkbox" checked>
            <span class="filter-checkbox-label">Все языки</span>
          `;

          // Создаем чекбоксы для каждого языка
          const languageCheckboxes = Array.from(SUPPORTED_LANGUAGES).map((lang) => {
            const checkbox = document.createElement('label');
            checkbox.className = 'filter-checkbox';
            checkbox.innerHTML = `
              <input type="checkbox" id="lang-${lang}" class="lang-checkbox" data-lang="${lang}">
              <span class="filter-checkbox-label language-badge lang-${lang}">${labelForLang(
              lang
            )}</span>
            `;
            return checkbox;
          });

          checkboxesContainer.appendChild(allCheckbox);
          languageCheckboxes.forEach((checkbox) => checkboxesContainer.appendChild(checkbox));

          row.innerHTML = `
            <label class="form-label">🧠 Фильтр по языку</label>
          `;
          row.appendChild(checkboxesContainer);
          container.appendChild(row);

          // Обработчики событий для чекбоксов
          const allCheckboxInput = allCheckbox.querySelector('#lang-all');
          const langCheckboxes = row.querySelectorAll('.lang-checkbox[data-lang]');

          // Обработчик для "Все языки"
          allCheckboxInput.addEventListener('change', (e) => {
            if (e.target.checked) {
              // Если выбрано "Все языки", снимаем выбор с остальных
              langCheckboxes.forEach((cb) => (cb.checked = false));
            }
            this.filterSnippets(document.getElementById('searchInput').value);
          });

          // Обработчики для языковых чекбоксов
          langCheckboxes.forEach((checkbox) => {
            checkbox.addEventListener('change', (e) => {
              if (e.target.checked) {
                // Если выбрали конкретный язык, снимаем "Все языки"
                allCheckboxInput.checked = false;
              } else {
                // Если сняли все языки, выбираем "Все языки"
                const anyChecked = Array.from(langCheckboxes).some((cb) => cb.checked);
                if (!anyChecked) {
                  allCheckboxInput.checked = true;
                }
              }
              this.filterSnippets(document.getElementById('searchInput').value);
            });
          });
        }

        renderSnippets(snippets = this.snippets) {
          const container = document.getElementById('snippetsContainer');

          if (snippets.length === 0) {
            container.innerHTML = `
                        <div class="card text-center text-muted">
                            <p>Снипеты не найдены</p>
                        </div>
                    `;
            return;
          }

          container.innerHTML = snippets
            .map(
              (snippet) => `
                    <div class="card snippet-card" data-id="${snippet.id}">
                        <div class="flex items-start justify-between mb-2">
                            <h3 class="text-lg font-semibold">${snippet.name}</h3>
                            <span class="language-badge lang-${snippet.language}">
                              ${emojiForLang(snippet.language)} ${labelForLang(snippet.language)}
                            </span>
                        </div>
                        <div class="code-preview" onclick="snippetManager.viewCode(${
                          snippet.id
                        })" onscroll="snippetManager.syncPreviewScroll(event)" title="Кликните для просмотра на полный экран">
                          <div class="code-preview-wrapper">
                            <div class="code-preview-numbers">${this.generateLineNumbersHTML(
                              snippet.code
                            )}</div>
                            <div class="code-preview-content">${this.generateCodeLinesHTML(
                              snippet.code,
                              snippet.language
                            )}</div>
                          </div>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button class="btn-secondary text-xs" onclick="snippetManager.editSnippet(${
                              snippet.id
                            })">
                                ✏️ Редактировать
                            </button>
                            <button class="btn-secondary text-xs" onclick="snippetManager.copySnippet(${
                              snippet.id
                            }, event)">
                                📋 Копировать
                            </button>
                            <button class="btn-secondary text-xs" onclick="snippetManager.deleteSnippet(${
                              snippet.id
                            })">
                                🗑️ Удалить
                            </button>
                        </div>
                    </div>
                `
            )
            .join('');

          // Подсветка синтаксиса
          if (typeof Prism !== 'undefined') {
            Prism.highlightAll();
          }

          // Подсветка синтаксиса для новых элементов
          setTimeout(() => {
            if (typeof Prism !== 'undefined') {
              // Подсвечиваем код в карточках
              const codeLines = container.querySelectorAll('.code-line span[class*="language-"]');
              codeLines.forEach((line) => {
                if (line.textContent.trim()) {
                  Prism.highlightElement(line);
                }
              });
            }
          }, 100);
        }

        openModal(snippetId = null) {
          this.currentSnippetId = snippetId;
          const modal = document.getElementById('snippetModal');
          const title = document.getElementById('modalTitle');
          const form = document.getElementById('snippetForm');

          if (snippetId) {
            const snippet = this.snippets.find((s) => s.id === snippetId);
            title.textContent = 'Редактировать снипет';
            document.getElementById('snippetName').value = snippet.name;
            document.getElementById('snippetLanguage').value = snippet.language;
            document.getElementById('snippetCode').value = snippet.code;
          } else {
            title.textContent = 'Новый снипет';
            form.reset();
          }

          modal.classList.remove('hidden');
          document.getElementById('snippetName').focus();

          // Обновляем номера строк после открытия модального окна
          setTimeout(() => {
            this.updateEditorLineNumbers();
          }, 100);
        }

        closeModal() {
          document.getElementById('snippetModal').classList.add('hidden');
          this.currentSnippetId = null;
        }

        saveSnippet() {
          const name = document.getElementById('snippetName').value;
          const language = document.getElementById('snippetLanguage').value;
          const code = document.getElementById('snippetCode').value;

          if (!name || !code) return;

          fetch('/rust/snippets/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: this.currentSnippetId, name, language, code }),
          })
            .then((r) => r.json())
            .then((res) => {
              if (res.ok) {
                this.fetchFromServer();
                this.closeModal();
              } else {
                alert('Ошибка сохранения: ' + (res.error || 'unknown'));
              }
            })
            .catch((e) => alert('Ошибка: ' + e));
        }

        editSnippet(id) {
          this.openModal(id);
        }

        copySnippet(id, event) {
          const snippet = this.snippets.find((s) => s.id === id);
          navigator.clipboard.writeText(snippet.code).then(() => {
            // Показать уведомление
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '✅ Скопировано';
            btn.style.background = 'var(--ok)';
            btn.style.color = 'white';
            setTimeout(() => {
              btn.textContent = originalText;
              btn.style.background = '';
              btn.style.color = '';
            }, 2000);
          });
        }

        deleteSnippet(id) {
          if (!confirm('Удалить этот снипет?')) return;
          fetch('/rust/snippets/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id }),
          })
            .then((r) => r.json())
            .then((res) => {
              if (res.ok) this.fetchFromServer();
              else alert('Ошибка удаления: ' + (res.error || 'unknown'));
            })
            .catch((e) => alert('Ошибка: ' + e));
        }

        viewCode(id) {
          const snippet = this.snippets.find((s) => s.id === id);
          if (!snippet) {
            console.error('Snippet not found:', id);
            return;
          }

          console.log('Opening code modal for snippet:', snippet);

          const modal = document.getElementById('codeModal');
          const title = document.getElementById('codeModalTitle');
          const codeElement = document.getElementById('codeModalCode');

          if (!modal || !title || !codeElement) {
            console.error('Modal elements not found');
            return;
          }

          title.innerHTML = `${snippet.name} <span class="language-badge lang-${
            snippet.language
          }">${emojiForLang(snippet.language)} ${labelForLang(snippet.language)}</span>`;

          // Генерируем номера строк и код с новой структурой
          const lineNumbersElement = document.getElementById('codeModalLineNumbers');

          lineNumbersElement.innerHTML = this.generateLineNumbersHTML(snippet.code);
          codeElement.innerHTML = this.generateCodeLinesHTML(snippet.code, snippet.language);

          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden';

          // Подсветка синтаксиса в модальном окне
          setTimeout(() => {
            if (typeof Prism !== 'undefined') {
              // Подсвечиваем каждую строку кода отдельно
              const codeLines = codeElement.querySelectorAll('.code-line span[class*="language-"]');
              codeLines.forEach((line) => {
                if (line.textContent.trim()) {
                  Prism.highlightElement(line);
                }
              });
            }
          }, 100);
        }

        closeCodeModal() {
          const modal = document.getElementById('codeModal');
          modal.classList.add('hidden');
          document.body.style.overflow = '';
        }

        copyCodeFromModal() {
          const codeElement = document.getElementById('codeModalCode');
          const code = codeElement.textContent;

          navigator.clipboard.writeText(code).then(() => {
            const btn = document.getElementById('copyCodeBtn');
            const originalText = btn.textContent;
            btn.textContent = '✅ Скопировано';
            btn.style.background = 'var(--ok)';
            btn.style.color = 'white';
            setTimeout(() => {
              btn.textContent = originalText;
              btn.style.background = '';
              btn.style.color = '';
            }, 2000);
          });
        }

        generateLineNumbers(code, maxLines = 10) {
          const lines = code.split('\n');
          const visibleLines = lines.slice(0, maxLines);
          return visibleLines.map((_, index) => index + 1).join('\n');
        }

        generateAllLineNumbers(code) {
          const lines = code.split('\n');
          return lines.map((_, index) => index + 1).join('\n');
        }

        generateLineNumbersHTML(code) {
          const lines = code.split('\n');
          return lines
            .map((_, index) => `<div class="code-line-number"><span>${index + 1}</span></div>`)
            .join('');
        }

        generateCodeLinesHTML(code, language) {
          const lines = code.split('\n');
          return lines
            .map(
              (line) =>
                `<div class="code-line"><span class="language-${language}">${this.escapeHtml(
                  line
                )}</span></div>`
            )
            .join('');
        }

        truncateCode(code, maxLines = 10) {
          const lines = code.split('\n');
          if (lines.length <= maxLines) {
            return code;
          }
          return lines.slice(0, maxLines).join('\n') + '\n...';
        }

        updateEditorLineNumbers() {
          const textarea = document.getElementById('snippetCode');
          const lineNumbers = document.getElementById('editorLineNumbers');

          if (!textarea || !lineNumbers) return;

          const lines = textarea.value.split('\n');
          const numbers = lines.map((_, index) => index + 1).join('\n');
          lineNumbers.textContent = numbers;
        }

        syncEditorScroll() {
          const textarea = document.getElementById('snippetCode');
          const lineNumbers = document.getElementById('editorLineNumbers');

          if (!textarea || !lineNumbers) return;

          lineNumbers.scrollTop = textarea.scrollTop;
        }

        syncPreviewScroll(e) {
          const container = e.currentTarget;
          const numbers = container.querySelector('.code-preview-numbers');
          const content = container.querySelector('.code-preview-content');

          if (!numbers || !content) return;

          // Синхронизируем скролл
          numbers.scrollTop = container.scrollTop;
          content.scrollTop = container.scrollTop;
        }

        escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }
      }

      // Инициализация
      const snippetManager = new SnippetManager();
    </script>
  </body>
</html>

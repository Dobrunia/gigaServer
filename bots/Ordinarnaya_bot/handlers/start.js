const userStorage = require('../utils/userStorage');

const startHandler = (bot) => {
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
  bot.onText(/\/start/, (msg) => {
    const chatId = msg.chat.id;
    const userCount = userStorage.getUserCount();

    const helpText = `
üí¨ *–ê–Ω–æ–Ω–∏–º–Ω—ã–π —á–∞—Ç*

–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ó–¥–µ—Å—å —Ç—ã –º–æ–∂–µ—à—å –æ–±—â–∞—Ç—å—Å—è –∞–Ω–æ–Ω–∏–º–Ω–æ —Å –¥—Ä—É–≥–∏–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏.

*–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:*
‚Ä¢ –ù–∞–∂–º–∏ "üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è" —á—Ç–æ–±—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —á–∞—Ç—É
‚Ä¢ –ù–∞–ø–∏—à–∏ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - –æ–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –∞–Ω–æ–Ω–∏–º–Ω–æ
‚Ä¢ –ù–∞–∂–º–∏ "‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è" —á—Ç–æ–±—ã –≤—ã–π—Ç–∏ –∏–∑ —á–∞—Ç–∞
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π "üë• –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ–Ω–ª–∞–π–Ω" —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

*–ß—Ç–æ –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å:*
‚úÖ –¢–µ–∫—Å—Ç, —Å—Ç–∏–∫–µ—Ä—ã, —Ñ–æ—Ç–æ, –≥–æ–ª–æ—Å–æ–≤—ã–µ, –≤–∏–¥–µ–æ
‚ùå –§–∞–π–ª—ã –∑–∞–ø—Ä–µ—â–µ–Ω—ã

*–°–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω: ${userCount} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤*
    `;

    const keyboard = {
      keyboard: [
        [{ text: 'üë• –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ–Ω–ª–∞–π–Ω' }],
        [{ text: 'üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è' }, { text: '‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è' }],
      ],
      resize_keyboard: true,
    };

    bot.sendMessage(chatId, helpText, {
      parse_mode: 'Markdown',
      reply_markup: keyboard,
    });
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ–Ω–ª–∞–π–Ω"
  bot.onText(/üë• –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ–Ω–ª–∞–π–Ω/, (msg) => {
    const chatId = msg.chat.id;
    const allUsers = userStorage.getAllUsers();
    const userCount = allUsers.length;

    let onlineText;

    if (userCount === 0) {
      onlineText = 'üë• –í –∞–Ω–æ–Ω–∏–º–Ω–æ–º —á–∞—Ç–µ –ø–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç.\n\n–ù–∞–∂–º–∏ /connect —á—Ç–æ–±—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è!';
    } else if (userCount === 1) {
      onlineText = `üë• *–û–Ω–ª–∞–π–Ω –≤ –∞–Ω–æ–Ω–∏–º–Ω–æ–º —á–∞—Ç–µ: ${userCount}*\n\n–¢–æ–ª—å–∫–æ —Ç—ã –≤ —á–∞—Ç–µ. –ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–∑–µ–π! üë§`;
    } else {
      onlineText = `üë• *–û–Ω–ª–∞–π–Ω –≤ –∞–Ω–æ–Ω–∏–º–Ω–æ–º —á–∞—Ç–µ: ${userCount}*\n\n–ê–∫—Ç–∏–≤–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${userCount}\n\nüí¨ –ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏ –æ–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –∞–Ω–æ–Ω–∏–º–Ω–æ!`;
    }

    bot.sendMessage(chatId, onlineText, { parse_mode: 'Markdown' });
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"
  bot.onText(/üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è/, (msg) => {
    const chatId = msg.chat.id;
    const user = msg.from;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    if (userStorage.isUserRegistered(chatId)) {
      bot.sendMessage(chatId, '‚úÖ –¢—ã —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ –∞–Ω–æ–Ω–∏–º–Ω–æ–º—É —á–∞—Ç—É!');
      return;
    }

    // –ü–æ–¥–∫–ª—é—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    userStorage.addUser(chatId, user);

    // –£–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    const allUsers = userStorage.getAllUsers();
    const otherUsers = allUsers.filter((u) => u.chatId !== chatId);

    otherUsers.forEach((otherUser) => {
      try {
        bot.sendMessage(
          otherUser.chatId,
          `üÜï –ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∞–Ω–æ–Ω–∏–º–Ω–æ–º—É —á–∞—Ç—É!\n\nüë• –í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${allUsers.length}`
        );
      } catch (error) {
        console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${otherUser.chatId}:`, error);
      }
    });

    bot.sendMessage(
      chatId,
      `‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!\n\n–¢–µ–ø–µ—Ä—å —Ç—ã –≤ –∞–Ω–æ–Ω–∏–º–Ω–æ–º —á–∞—Ç–µ. –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏ –æ–Ω–æ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º.`
    );
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è"
  bot.onText(/‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è/, (msg) => {
    const chatId = msg.chat.id;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–¥–∫–ª—é—á–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    if (!userStorage.isUserRegistered(chatId)) {
      bot.sendMessage(chatId, '‚ùå –¢—ã –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ –∞–Ω–æ–Ω–∏–º–Ω–æ–º—É —á–∞—Ç—É!');
      return;
    }

    // –û—Ç–∫–ª—é—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    userStorage.removeUser(chatId);

    // –£–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    const allUsers = userStorage.getAllUsers();

    allUsers.forEach((otherUser) => {
      try {
        bot.sendMessage(
          otherUser.chatId,
          `üëã –£—á–∞—Å—Ç–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª –∞–Ω–æ–Ω–∏–º–Ω—ã–π —á–∞—Ç!\n\nüë• –û—Å—Ç–∞–ª–æ—Å—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${allUsers.length}`
        );
      } catch (error) {
        console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${otherUser.chatId}:`, error);
      }
    });

    bot.sendMessage(
      chatId,
      `üëã –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!\n\n–¢—ã –±–æ–ª—å—à–µ –Ω–µ –ø–æ–ª—É—á–∞–µ—à—å —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ —á–∞—Ç–∞.`
    );
  });
};

module.exports = startHandler;
